<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{{ url_for('static', filename = 'sass/main.css') }}" type="text/css">
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css"
    integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ="
    crossorigin="anonymous"
  />
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script>
    function opennavbar(){
        $('.navbar').toggleClass('show-navbar');
    }
    function showsublist(param , value){
        $('ul', param).toggleClass(value);
    }
    function logout(){
        localStorage.clear();
        window.location.href = '/';
    }
    function loadnavbar(){ 
        priority = localStorage.getItem('faculty_type');
        console.log(priority);
        var temp = `
        <ul class="nav__ul">
                <li class="nav__li" onclick="window.location.href = 'home' ">Home</li>
                <li class="nav__li teacherli" onclick="showsublist($(this), 'show')">Professor<span></span>
                    <ul class="sub ">
                        <!--Add show on click of teacherli-->`;
        if(priority > 2){
            temp += `
                <li class="sub__li" onclick="window.location.href = 'teachers'">View All Teachers</li>
                <li class="sub__li" onclick="window.location.href = 'approval'">Approve Register Request</li>
                <li class="sub__li" onclick="window.location.href = 'assignclass'">Assign Class teachers</li>
            `;
        }
        if(priority > 1){
            temp += `
            <li class="sub__li" onclick="window.location.href = 'assignteacher'">Add subjects</li>
            `;
        }
        temp += `</ul>
                </li>
                <li class="nav__li studentli" onclick="showsublist($(this), 'show')"><div class="student">Students</div>
                    <ul class="sub studentlist">`;
        if(priority > 1){
            temp += `
                <li class="sub__li" onclick=" window.location.href = 'addstudent'"> Add students</li>
            `;
        }
        temp += `
                        <li class="sub__li" onclick=" window.location.href = 'addattendance'">Manage attendace</li>
                        <li class="sub__li" onclick=" window.location.href = 'iamarks'"> Manage IA marks</li>
                    </ul>
                </li>
            </ul>
        `;
        $('.navbar').html(temp);
    }
</script>
<script>
    $(document).ready(function(){
        var faculty_id = localStorage.getItem('faculty_id');
        var authkey = localStorage.getItem('authkey');
        if(faculty_id == null || authkey == null){
            window.location.href = "/";
        }
        loadnavbar();
        var pic = localStorage.getItem("teacher_picture");
        console.log(pic);
        var img = ` <img src="data:image/jpg;base64, `+ pic + `" alt="" class="header__logout__img" >`
        $('.header__logout__pic').html(img);
        
        var data = {
            "authkey": localStorage.getItem("authkey"),
            "faculty_id": localStorage.getItem("faculty_id")
        };
        $('#dept-id').change(function(){
            if ($('#dept-id').val() != "Select branch") {
                $('#year-id').removeAttr('disabled');
                var d = {
                    'authkey': localStorage.getItem('authkey'),
                    'faculty_id': localStorage.getItem('faculty_id'),
                    'department': $('#dept-id').val()
                };
                $.ajax({
                    type: "POST",
                    url: "get_year_sem_sec",
                    dataType: 'Json',
                    contentType: 'application/json',
                    data: JSON.stringify(d),
                    processData: false,
                    success: function (ret_obj) {
                        console.log(ret_obj);
                        var d = "<option selected>Select year</option>";
                        for (i = 0; i < (ret_obj['data']).length; i++) {
                            d += `'<option value="` + ret_obj['data'][i]['0'] + `">` + ret_obj['data'][i]['0'] + `</option>'`;
                        }
                        $('#year-id').html(d);
                    }
                });
            }
            else {
                $('#year-id').attr('disabled', true);
                $('#sem-id').attr('disabled', true);
                $('#sec-id').attr('disabled', true);
                $('#subject-id').attr('disabled', true);
                $('#submit-attendance-search').attr('disabled', true);
            }
        });
        $('#year-id').change(function(){
            if ($('#year-id').val() != "Select year") {
                $('#sem-id').removeAttr('disabled');
                var d = {
                    'authkey': localStorage.getItem('authkey'),
                    'faculty_id': localStorage.getItem('faculty_id'),
                    'department': $('#dept-id').val(),
                    'year': $('#year-id').val()
                };
                $.ajax({
                    type: "POST",
                    url: "get_year_sem_sec",
                    dataType: 'Json',
                    contentType: 'application/json',

                    data: JSON.stringify(d),
                    processData: false,
                    success: function (ret_obj) {
                        console.log(ret_obj);
                        var d = "<option selected>Select sem</option>";
                        for (i = 0; i < (ret_obj['data']).length; i++) {
                            d += `'<option value="` + ret_obj['data'][i]['0'] + `">` + ret_obj['data'][i]['0'] + `</option>'`;
                        }
                        $('#sem-id').html(d);
                    }
                });
            }
            else {
                $('#sem-id').attr('disabled', true);
                $('#sec-id').attr('disabled', true);
                $('#subject-id').attr('disabled', true);
                $('#submit-attendance-search').attr('disabled', true);
            }
        });

        $('#sem-id').change(function(){
            if ($('#sem-id').val() != "Select sem") {
                $('#sec-id').removeAttr('disabled');
                var d = {
                    'authkey': localStorage.getItem('authkey'),
                    'faculty_id': localStorage.getItem('faculty_id'),
                    'department': $('#dept-id').val(),
                    'year': $('#year-id').val(),
                    'sem': $('#sem-id').val()
                };
                $.ajax({
                    type: "POST",
                    url: "get_year_sem_sec",
                    dataType: 'Json',
                    contentType: 'application/json',

                    data: JSON.stringify(d),
                    processData: false,
                    success: function (ret_obj) {
                        console.log(ret_obj);

                        var d = "<option selected>Select section</option>";
                        for (i = 0; i < (ret_obj['data']).length; i++) {
                            d += `'<option value="` + ret_obj['data'][i]['0'] + `">` + ret_obj['data'][i]['0'] + ` - Section </option>'`;
                        }
                        $('#sec-id').html(d);
                    }
                });
            }
            else {
                $('#sec-id').attr('disabled', true);
                $('#subject-id').attr('disabled', true);
                $('#submit-attendance-search').attr('disabled', true);
            }
        });

        $('#sec-id').change(function(){
            if($('#sec-id').val() != "Select section"){
                $('#subject-id').removeAttr('disabled');
                var d = {
                    'authkey': localStorage.getItem('authkey'),
                    'faculty_id': localStorage.getItem('faculty_id'),
                    'department': $('#dept-id').val(),
                    'year': $('#year-id').val(),
                    'sem': $('#sem-id').val(),
                    'sec' : $('#sec-id').val()
                };
                $.ajax({
                    type: "POST",
                    url: "get_year_sem_sec",
                    dataType: 'Json',
                    contentType: 'application/json',
                    data: JSON.stringify(d),
                    processData: false,
                    success: function (ret_obj) {
                        console.log(ret_obj);

                        var d = "<option selected>Select Subject</option>";
                        for (i = 0; i < (ret_obj['data']).length; i++) {
                            d += `'<option value="` + ret_obj['data'][i]['subject_name'] + `-`+ret_obj['data'][i]['subject_id']+`">` + ret_obj['data'][i]['subject_name'] + `</option>'`;
                        }
                        $('#subject-id').html(d);
                    }
                });
            }
            else{
                $('#subject-id').attr('disabled', true);
                $('#submit-attendance-search').attr('disabled', true);
            }
        });

        $('#subject-id').change(function(){
            $('#submit-attendance-search').removeAttr('disabled');
        });
    });
    function openaddattendance(){
        $('#myModal').removeClass('displaynone');
    }
    function closemodal(){
        $('#myModal').addClass('displaynone');
    }
    function submit_get_attendance(){
        subject_selected = $('#subject-id').val();
        var d = {
            'authkey': localStorage.getItem('authkey'),
            'faculty_id': localStorage.getItem('faculty_id'),
            'department': $('#dept-id').val(),
            'year': $('#year-id').val(),
            'sem': $('#sem-id').val(),
            'sec' : $('#sec-id').val(),
            'subject_name': subject_selected.split("-")[0],
            'subject_id': subject_selected.split("-")[1]
        };
        $.ajax({
            type: "POST",
            url: "get_student_attendance_details",
            dataType: 'Json',
            contentType: 'application/json',
            data: JSON.stringify(d),
            processData: false,
            success: function (ret_obj) {
                console.log(ret_obj);
                if(ret_obj['status_code'] == 200){
                    table_data = "";
                    for(i=0;i<ret_obj['data'].length ;i++){
                        table_data += '<tr id="student-'+ret_obj['data'][i]['student_id']+'">';
                        table_data += '<td class="attendance__modal__form__sl_no">'+(i+1)+'</td>';
                        table_data += '<td class="attendance__modal__form__name">'+ret_obj['data'][i]['name']+'</td>';
                        table_data += '<td class="attendance__modal__form__usn">'+ret_obj['data'][i]['usn']+'</td>';
                        table_data += '<td class="attendance__modal__form__attendance"><input type="checkbox" checked></td>';
                        table_data += '</tr>';
                    }
                    $('.student__names__table__tbody').html(table_data);
                }
            }
        });
        $.ajax({
            type: "POST",
            url: "get_attendance_details",
            dataType: 'Json',
            contentType: 'application/json',
            data: JSON.stringify(d),
            processData: false,
            success: function (ret_obj) {
                console.log(ret_obj);
                var table_heading = `
                <th>slno</th>
                <th>name</th>
                <th>USN</th>
                `;
                for(i=1;i<=ret_obj['data']['no_of_days']; i++){
                    table_heading += '<th>'+i+'</th>';
                }
                $('.attendance__table__heading').html(table_heading);
                var table_data = "";
                for(i=0;i<ret_obj['data']['student_details'].length; i++){
                    table_data += '<tr class="attendance__table__odd attendance__table__row">';
                table_data += '<td>'+(i+1)+'</td>';
                table_data += '<td>'+ret_obj['data']['student_details'][i][1]+'</td>';
                table_data += '<td>'+ret_obj['data']['student_details'][i][0]+'</td>';
                for(j=0;j<ret_obj['data']['attendance_matrix'][i].length; j++){
                    if(ret_obj['data']['attendance_matrix'][i][j] == -1){
                        table_data += '<td><i class="fa fa-minus"></i></td>';
                    }
                    else if(ret_obj['data']['attendance_matrix'][i][j] == 1){
                        table_data += '<td><i class="fa fa-check"></i></td>';
                    }else{
                        table_data += '<td><i class="fa fa-times"></i></td>';
                    }
                }
                    table_data += '</tr>';
                }
                $('.attendance__table tbody').html(table_data);
            }
        });
        $('.attendance__details').removeClass('displaynone');

    }
    function submitattendancedetails(){
        var final_data = [];
        $('.student__names__table__tbody > tr').each(function(){
            var name = $(".attendance__modal__form__name", this).text();
            var usn = $(".attendance__modal__form__usn", this).text();
            var chbox = $('.attendance__modal__form__attendance', this).find('input[type="checkbox"]').is(":checked");
            var student_id = $(this).attr('id');
            student_id = student_id.split("-")[1];
            d = {
                'student_id': student_id,
                'name' : name,
                'usn' : usn,
                'attendance': chbox
            };
            final_data.push(d);
        });
        subject_selected = $('#subject-id').val();
        temp = {
            'department': $('#dept-id').val(),
            'year': $('#year-id').val(),
            'sem': $('#sem-id').val(),
            'sec' : $('#sec-id').val(),
            'subject_name': subject_selected.split("-")[0],
            'subject_id': subject_selected.split("-")[1],
            'hour_no' : $('.attendance__modal__form #attendance__hour').val(),
            'student_data': final_data
        };
        d = {
            'authkey': localStorage.getItem('authkey'),
            'faculty_id': localStorage.getItem('faculty_id'),
            'data': temp
        };
        $.ajax({
            type: "POST",
            url: "add_student_attendance",
            dataType: 'Json',
            contentType: 'application/json',
            data: JSON.stringify(d),
            processData: false,
            success: function(ret_obj){
                console.log(ret_obj);
                $('#myModal').addClass('displaynone');
                submit_get_attendance();
            }
        });
    }
</script>

<style>
    .displaynone{
        display: none !important;
    }
    /* The Modal (background) */
.modal {
 /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content/Box */
.modal-content {
  background-color: #fefefe;
  margin: 15% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 60%; /* Could be more or less, depending on screen size */
}

/* The Close Button */
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}
#student__names__table{
    width: 100%;
    margin-top: 20px;
}
#student__names__table td{
    text-align: center;
}
</style>
</head>
<body>

<!-- The Modal -->
<div id="myModal" class="modal displaynone">

  <!-- Modal content -->
  <div class="modal-content">
    <span class="close" onclick="closemodal()">&times;</span>
    <h3>Add Attendance</h3>
    <div class="attendance__modal__form__container">
        <div class="attendance__modal__form">
            <label for="attendance__hour">Hour Number</label>
            <input type="number" id="attendance__hour">
        </div>
    </div>
    <div class="student_details">
        <table id="student__names__table">
            <thead>
                <tr>
                    <th>Sl.No</th>
                    <th>Name</th>
                    <th>USN</th>
                    <th>P/A</th>
                </tr>
            </thead>
            <tbody class="student__names__table__tbody">
                <!-- <tr>
                    <td>1</td>
                    <td>Amey</td>
                    <td>1rn</td>
                    <td><input type="checkbox" checked>1</td>
                </tr> -->
            </tbody>
        </table>
        <button id="submit-attendance-button" class="register__btn bluebtn student__submit"onclick="submitattendancedetails()"> Submit</button>
    </div>
  </div>

</div>
    <div class="container">
        <header class="header">
            <img src="{{ url_for('static' , filename = 'images/logo.jpg')}}" alt="" class="header__collegelogo">
            <div class="header__content1">
                <button class="nav-btn" onclick="opennavbar()"><i class="fa fa-bars fa-2x headericon"></i></button>
                <h3 class="header__heading">Student login</h3>
            </div>
            <div class="header__content2">
                <!-- <form action="" class="header__form search-show">
                    <input type="search" class="header__search" placeholder="Search here">
                    <button class="header__search-btn"><i class="fa fa-search fa-1x icon-sbtn"></i></button>
                </form> -->
                <div class="btn-shownone">
                    <i class="fa fa-search fa-2x "></i>       <!--Make the btn-shownone to display block on click-->
                </div>
                
                <div class="header__logout">
                    <div class="header__logout__group" onclick="showsublist($(this), 'header__logout__listshow')">
                        <div class="header__logout__pic">
                            <img src="../images/user-3.jpg" alt="" class="header__logout__img">
                        </div>
                        <div class="header__dots" ><i class="fa fa-ellipsis-v fa-1x"></i>
                            <ul class="header__logout__list ">   <!--Add header__logout__listshow on click of header__logout__group-->
                                <li><a href="home">My profile</a></li>
                                <!-- <li><a href="#">Settings</a></li> -->
                                <li><a href="#">Log out</a></li>
                            </ul>   
                        </div>
                        <p class="header__logout__name"><span class="header__logout__span">Admin</span>    
                            <ul class="header__logout__list ">   <!--Add header__logout__listshow on click of header__logout__group-->
                                <li><a href="home">My profile</a></li>
                                <!-- <li><a href="#">Settings</a></li> -->
                                <li><div onclick="logout()">Log out</div></li>
                            </ul>
                        </p>
                    </div>
                </div>
            </div>
        </header>
        <section class="section">
            <div class="navbar "> <!--Add show-navbar on click of nav button-->
                <ul class="nav__ul">
                    <li class="nav__li"><a href="">Home</a> </li>
                    <li class="nav__li teacherli"><a href="" class="teacher">Professor</a> <span></span>
                        <ul class="sub ">
                            <!--Add show on click of teacherli-->
                            
                            <li class="sub__li" onclick="window.location.href = 'assignclass'">Class teachers</li>
                            <li class="sub__li" onclick="window.location.href = 'assignteacher'">Add subjects</li>
                        </ul>
                    </li>
                    <li class="nav__li studentli"><a href="" class="student">Students</a>
                        <ul class="sub studentlist">
                            <!--Add show on click of studentli-->
                            <li class="sub__li" onclick=" window.location.href = 'addstudent'"> Add students</li>
                            
                            <li class="sub__li" onclick=" window.location.href = 'addattendance'">Manage attendace</li>
                            <li class="sub__li" onclick=" window.location.href = 'iamarks'"> Manage IA marks</li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="content">
                <div class="attendance">
                    <div class="attendance__year">
                        <div class="attendance__selectdept">
                            <select class="attendance__selectdept__select" id="dept-id">
                                <option value="" selected>Select branch</option>
                                <option value="CSE">CSE</option>
                                <option value="ISE">ISE</option>
                                <option value="ECE">ECE</option>
                                <option value="EEE">EEE</option>
                            </select>
                        </div>
                        <div class="attendance__selectyear">
                            <select id="year-id" class="attendance__selectyear__select" disabled>
                                <option value="none" selected >Select year</option>
                                <!-- <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option> -->
                            </select>
                        </div>

                        <div class="attendance__selectsection">
                            <select id="sem-id" class="attendance__selectsection__select" disabled>
                                <option value="none" selected >Select sem</option>
                                <!-- <option value="2">2</option>
                                <option value="4">4</option>
                                <option value="6">6</option> -->
                            </select>
                        </div>

                        <div class="attendance__selectsection">
                            <select id="sec-id" class="attendance__selectsection__select" disabled>
                                <option value="none" selected>Select section</option>
                                <!-- <option value="a">A section</option>
                                <option value="b">B section</option> -->
                            </select>
                        </div>

                        <div class="attendance__selectsubject">
                            <select id="subject-id" class="attendance__selectsubject__select" disabled>
                                <option value="none">Select Subject</option>
                            </select>
                        </div> 
                        <button class="register__btn bluebtn attendance__submit" id="submit-attendance-search" onclick="submit_get_attendance()" disabled>Submit</button>
                        <!-- <select  id="" class="attendance__year__sem">
                            <option value="2nd sem">2nd sem</option>
                            <option value="4th sem">4th sem</option>
                            <option value="6th sem">6th sem</option>
                            <option value="8th sem">8th sem</option>
                        </select> -->
                        <!-- <select  id="" class="attendance__year__section">
                            <option value="A">A section</option>
                            <option value="B">B section</option>
                        </select> -->
                        <!-- <select  id="" class="attendance__year__month">
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                        </select> -->
                    </div>
                    <div class="attendance__details displaynone">
                        <button class="attendance__details__addbtn" id="add_attendance_button" onclick="openaddattendance()">Add Attendance</button>
                        <table class="attendance__table">
                            <thead>
                                <tr class="attendance__table__heading">
                                    <th>slno</th>
                                    <th>name</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
</body>
<!-- <script src="{{ url_for('static', filename = 'js/nav.js') }}"></script> -->
<!-- <script src="{{ url_for('static', filename = 'js/sample.js') }}"></script> -->
<!-- <script>
    var modal = document.getElementById("myModal");

// Get the button that opens the modal
var btn = document.getElementById("add_attendance_button");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on the button, open the modal
// btn.onclick = function() {
//   modal.style.display = "block";
// }

// When the user clicks on <span> (x), close the modal
// span.onclick = function() {
//   modal.style.display = "none";
// }

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
</script> -->
</html>